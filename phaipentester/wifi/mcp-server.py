#!/usr/bin/env python3

import importlib
import subprocess
import sys
import asyncio
import json
import websockets
import time
import os
import shutil
import shlex
import stat
import signal

# --------------------------------------------------------
# CONFIG
# --------------------------------------------------------

vHost = "127.0.0.1"
vPort = 9003  # Puerto diferente al web (9001) y network (9002)

# --------------------------------------------------------
# HELPERS GENERALES
# --------------------------------------------------------

def fEjecutarComando(vCmd):
  try:
    print(f"[CMD] Ejecutando: {vCmd}")
    v = subprocess.run(vCmd, shell=True, capture_output=True, text=True)
    return v.stdout + "\n" + v.stderr
  except Exception as e:
    return str(e)

def fAsegurarHerramienta(vNombre):
  if not shutil.which(vNombre):
    return False
  return True

# --------------------------------------------------------
# HERRAMIENTAS WIRELESS
# --------------------------------------------------------

def fWifiScanInterface(vInterface, vAction, vWorkspace):
  if not fAsegurarHerramienta("airmon-ng"):
    return "ERROR: airmon-ng no encontrado. Instala aircrack-ng."
  
  vAction = vAction or "check"
  
  if vAction == "start":
    vCmd = f"sudo airmon-ng start {shlex.quote(vInterface)}"
    vMsg = "Iniciando modo monitor..."
  elif vAction == "stop":
    vCmd = f"sudo airmon-ng stop {shlex.quote(vInterface)}"
    vMsg = "Deteniendo modo monitor..."
  else:
    vCmd = "sudo airmon-ng"
    vMsg = "Verificando interfaces..."

  vSalida = fEjecutarComando(vCmd)
  return f"{vMsg}\n{vSalida}"

def fWifiScanNetworks(vInterface, vDuration, vWorkspace):
  if not fAsegurarHerramienta("airodump-ng"):
    return "ERROR: airodump-ng no encontrado."

  vSalidaCSV = os.path.join(vWorkspace, "evidence", f"airodump_scan_{int(time.time())}")
  os.makedirs(os.path.dirname(vSalidaCSV), exist_ok=True)

  vDuration = int(vDuration) if vDuration else 15
  vInterface = vInterface or "wlan0mon"

  # airodump-ng no termina solo f치cilmente con timeout en subprocess.Run si tiene output interactivo.
  # Usamos timeout command de linux.
  vCmd = f"sudo timeout {vDuration} airodump-ng -w {shlex.quote(vSalidaCSV)} --output-format csv {shlex.quote(vInterface)}"
  
  vSalida = fEjecutarComando(vCmd)
  
  # Leemos el CSV generado para devolver resultados estructurados si es posible, o al menos el texto
  vFileCSV = vSalidaCSV + "-01.csv"
  if os.path.exists(vFileCSV):
    try:
      with open(vFileCSV, "r", encoding="utf-8", errors="replace") as f:
        vContenido = f.read()
      return f"Escaneo finalizado. Archivo guardado: {vFileCSV}\n\nCONTENIDO CSV:\n{vContenido}"
    except Exception as e:
      return f"Escaneo finalizado pero error al leer CSV: {e}"
  
  return f"Escaneo finalizado. No se gener칩 archivo CSV. Salida:\n{vSalida}"

def fWifiCaptureHandshake(vInterface, vBSSID, vChannel, vDuration, vWorkspace):
  if not fAsegurarHerramienta("airodump-ng"):
    return "ERROR: airodump-ng no encontrado."

  vSalidaBase = os.path.join(vWorkspace, "evidence", f"handshake_{vBSSID.replace(':','-')}_{int(time.time())}")
  os.makedirs(os.path.dirname(vSalidaBase), exist_ok=True)

  vDuration = int(vDuration) if vDuration else 60
  vInterface = vInterface or "wlan0mon"
  vChannel = vChannel or "1"

  vCmd = (
    f"sudo timeout {vDuration} airodump-ng "
    f"--bssid {shlex.quote(vBSSID)} "
    f"--channel {shlex.quote(vChannel)} "
    f"-w {shlex.quote(vSalidaBase)} "
    f"{shlex.quote(vInterface)}"
  )
  
  vSalida = fEjecutarComando(vCmd)
  return f"Captura finalizada. Archivos guardados con prefijo: {vSalidaBase}\nVerifica si existe el .cap para cracking."

def fWifiDeauth(vInterface, vBSSID, vClient, vCount, vWorkspace):
  if not fAsegurarHerramienta("aireplay-ng"):
    return "ERROR: aireplay-ng no encontrado."

  vCount = vCount or "5"
  vClient = vClient or "FF:FF:FF:FF:FF:FF" # Broadcast si no se especifica
  vInterface = vInterface or "wlan0mon"
  
  vCmd = (
    f"sudo aireplay-ng --deauth {shlex.quote(str(vCount))} "
    f"-a {shlex.quote(vBSSID)} "
    f"-c {shlex.quote(vClient)} "
    f"{shlex.quote(vInterface)}"
  )
  
  vSalida = fEjecutarComando(vCmd)
  return vSalida

def fWifiCrack(vWorkspace, vPcapFile, vWordlist):
  if not fAsegurarHerramienta("aircrack-ng"):
    return "ERROR: aircrack-ng no encontrado."

  if not vWordlist:
    vWordlist = "/usr/share/wordlists/rockyou.txt"
  
  vCmd = f"aircrack-ng -w {shlex.quote(vWordlist)} {shlex.quote(vPcapFile)}"
  
  vSalida = fEjecutarComando(vCmd)
  return vSalida


# --------------------------------------------------------
# REPORT (Reutilizados)
# --------------------------------------------------------

def fReportWrite(vWorkspace, vSection, vContent):
  vReportFile = os.path.join(vWorkspace, "report", "findings.txt")
  os.makedirs(os.path.dirname(vReportFile), exist_ok=True)
  vLinea = f"\n=== {vSection} ===\n{vContent}\n"
  with open(vReportFile, "a") as f:
    f.write(vLinea)
  return {"status": "ok", "written": vLinea}

def fReportFinalMD(vWorkspace, vContent):
  vReportFile = os.path.join(vWorkspace, "report", "final.md")
  os.makedirs(os.path.dirname(vReportFile), exist_ok=True)
  with open(vReportFile, "w") as f:
    f.write(vContent)
  return {"status": "ok", "path": vReportFile}

def fReportFinalHTML(vWorkspace, vContent):
  vReportFile = os.path.join(vWorkspace, "report", "final.html")
  os.makedirs(os.path.dirname(vReportFile), exist_ok=True)
  with open(vReportFile, "w") as f:
    f.write(vContent)
  return {"status": "ok", "path": vReportFile}


# --------------------------------------------------------
# MANEJO DE SOLICITUDES MCP
# --------------------------------------------------------

async def fHandle(vWS):
  print(f"[MCP] Nueva conexi칩n establecida desde {vWS.remote_address}")

  async for vMensaje in vWS:
    vJSON = json.loads(vMensaje)
    vMethod = vJSON.get("method")
    vID = vJSON.get("id")

    print(f"[MCP] Petici칩n recibida: {vMethod}")

    if vMethod == "tools/list":
      vRespuesta = {
        "jsonrpc": "2.0",
        "id": vID,
        "result": {
          "tools": [
            {"name": "wifi.scan_interface"},
            {"name": "wifi.scan_networks"},
            {"name": "wifi.capture_handshake"},
            {"name": "wifi.deauth"},
            {"name": "wifi.crack"},
            {"name": "report.write"},
            {"name": "report.final_md"},
            {"name": "report.final_html"}
          ]
        }
      }
      await vWS.send(json.dumps(vRespuesta))
      continue

    if vMethod == "tools/call":
      vTool = vJSON["params"]["tool"]
      vArgs = vJSON["params"]["arguments"]

      print(f"[MCP] Ejecutando herramienta: {vTool}")

      vOutput = {}

      if vTool == "wifi.scan_interface":
        vOutput = fWifiScanInterface(
          vArgs.get("interface"), 
          vArgs.get("action"), 
          vArgs.get("workspace")
        )

      elif vTool == "wifi.scan_networks":
        vOutput = fWifiScanNetworks(
          vArgs.get("interface"), 
          vArgs.get("duration"), 
          vArgs.get("workspace")
        )

      elif vTool == "wifi.capture_handshake":
        vOutput = fWifiCaptureHandshake(
          vArgs.get("interface"), 
          vArgs.get("bssid"), 
          vArgs.get("channel"), 
          vArgs.get("duration"), 
          vArgs.get("workspace")
        )

      elif vTool == "wifi.deauth":
        vOutput = fWifiDeauth(
          vArgs.get("interface"), 
          vArgs.get("bssid"), 
          vArgs.get("client"), 
          vArgs.get("count"), 
          vArgs.get("workspace")
        )

      elif vTool == "wifi.crack":
        vOutput = fWifiCrack(
          vArgs.get("workspace"), 
          vArgs.get("pcap_file"), 
          vArgs.get("wordlist")
        )

      elif vTool == "report.write":
        vOutput = fReportWrite(vArgs["workspace"], vArgs["section"], vArgs["content"])
      
      elif vTool == "report.final_md":
        vOutput = fReportFinalMD(vArgs["workspace"], vArgs["content"])
      
      elif vTool == "report.final_html":
        vOutput = fReportFinalHTML(vArgs["workspace"], vArgs["content"])

      # Enviar respuesta
      vRespuesta = {
        "jsonrpc": "2.0",
        "id": vID,
        "result": {"output": vOutput}
      }
      await vWS.send(json.dumps(vRespuesta))
      continue


# --------------------------------------------------------
# MAIN SERVER
# --------------------------------------------------------

async def main():
  print(f"\n{'='*60}")
  print(f"MCP WIFI Pentesting Server")
  print(f"{'='*60}")
  print(f"Escuchando en: ws://{vHost}:{vPort}")
  print(f"Estado: ACTIVO")
  print(f"{'='*60}\n")
  print("Esperando conexiones...\n")

  async with websockets.serve(fHandle, vHost, vPort):
    await asyncio.Future()

if __name__ == "__main__":
  asyncio.run(main())
