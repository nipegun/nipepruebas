#!/usr/bin/env python3

import importlib
import subprocess
import sys
import asyncio
import json
import websockets
import time
import os
import shutil
import shlex
import stat

# --------------------------------------------------------
# CONFIG
# --------------------------------------------------------

vHost = "127.0.0.1"
vPort = 9004  # Puerto diferente al web (9001), net (9002), wifi (9003)

# --------------------------------------------------------
# HELPERS GENERALES
# --------------------------------------------------------

def fEjecutarComando(vCmd):
  try:
    print(f"[CMD] Ejecutando: {vCmd}")
    v = subprocess.run(vCmd, shell=True, capture_output=True, text=True)
    return v.stdout + "\n" + v.stderr
  except Exception as e:
    return str(e)

def fAsegurarHerramienta(vNombre):
  if not shutil.which(vNombre):
    return False
  return True

# --------------------------------------------------------
# HERRAMIENTAS BLUETOOTH
# --------------------------------------------------------

def fBtScanDiscovery(vWorkspace, vTimeout):
  if not fAsegurarHerramienta("hcitool"):
    return "ERROR: hcitool no encontrado (paquete bluez)."
  
  vTimeout = vTimeout or "10"
  
  # Usamos hcitool scan para dispositivos visibles clásicos
  # También se podría usar scan básico
  vCmd = f"timeout {shlex.quote(str(vTimeout))} hcitool scan"
  vSalida = fEjecutarComando(vCmd)
  
  # Guardar evidencia
  vSalidaFile = os.path.join(vWorkspace, "evidence", f"bt_scan_{int(time.time())}.txt")
  os.makedirs(os.path.dirname(vSalidaFile), exist_ok=True)
  with open(vSalidaFile, "w") as f:
    f.write(vSalida)
    
  return f"Escaneo finalizado.\n{vSalida}\nGuardado en {vSalidaFile}"

def fBtInfo(vMAC, vWorkspace):
  if not fAsegurarHerramienta("hcitool"):
    return "ERROR: hcitool no encontrado."

  if not vMAC:
    return "ERROR: MAC address requerida."

  vCmd = f"hcitool info {shlex.quote(vMAC)}"
  vSalida = fEjecutarComando(vCmd)
  
  return vSalida

def fBtServices(vMAC, vWorkspace):
  if not fAsegurarHerramienta("sdptool"):
    return "ERROR: sdptool no encontrado."

  if not vMAC:
    return "ERROR: MAC address requerida."

  vSalidaFile = os.path.join(vWorkspace, "evidence", f"bt_sdp_{vMAC.replace(':','-')}.txt")
  os.makedirs(os.path.dirname(vSalidaFile), exist_ok=True)

  vCmd = f"sdptool browse {shlex.quote(vMAC)}"
  vSalida = fEjecutarComando(vCmd)
  
  with open(vSalidaFile, "w") as f:
    f.write(vSalida)
    
  return f"Enumeración de servicios completada.\nGuardada en {vSalidaFile}\n(Resumen truncado si es largo...)"

def fBtL2Ping(vMAC, vCount, vWorkspace):
  if not fAsegurarHerramienta("l2ping"):
    return "ERROR: l2ping no encontrado."

  if not vMAC:
    return "ERROR: MAC address requerida."
  
  vCount = vCount or "4"
  
  vCmd = f"sudo l2ping -c {shlex.quote(str(vCount))} {shlex.quote(vMAC)}"
  vSalida = fEjecutarComando(vCmd)
  
  return vSalida

def fBtScanLE(vWorkspace, vTimeout):
  if not fAsegurarHerramienta("hcitool"):
    return "ERROR: hcitool no encontrado."
  
  vTimeout = vTimeout or "10"
  
  # lescan requiere sudo y suele ser interactivo infinito, timeout es mandatorio
  vCmd = f"sudo timeout {shlex.quote(str(vTimeout))} hcitool lescan"
  vSalida = fEjecutarComando(vCmd)
  
  return vSalida

# --------------------------------------------------------
# REPORT (Reutilizados)
# --------------------------------------------------------

def fReportWrite(vWorkspace, vSection, vContent):
  vReportFile = os.path.join(vWorkspace, "report", "findings.txt")
  os.makedirs(os.path.dirname(vReportFile), exist_ok=True)
  vLinea = f"\n=== {vSection} ===\n{vContent}\n"
  with open(vReportFile, "a") as f:
    f.write(vLinea)
  return {"status": "ok", "written": vLinea}

def fReportFinalMD(vWorkspace, vContent):
  vReportFile = os.path.join(vWorkspace, "report", "final.md")
  os.makedirs(os.path.dirname(vReportFile), exist_ok=True)
  with open(vReportFile, "w") as f:
    f.write(vContent)
  return {"status": "ok", "path": vReportFile}

def fReportFinalHTML(vWorkspace, vContent):
  vReportFile = os.path.join(vWorkspace, "report", "final.html")
  os.makedirs(os.path.dirname(vReportFile), exist_ok=True)
  with open(vReportFile, "w") as f:
    f.write(vContent)
  return {"status": "ok", "path": vReportFile}


# --------------------------------------------------------
# MANEJO DE SOLICITUDES MCP
# --------------------------------------------------------

async def fHandle(vWS):
  print(f"[MCP] Nueva conexión establecida desde {vWS.remote_address}")

  async for vMensaje in vWS:
    vJSON = json.loads(vMensaje)
    vMethod = vJSON.get("method")
    vID = vJSON.get("id")

    print(f"[MCP] Petición recibida: {vMethod}")

    if vMethod == "tools/list":
      vRespuesta = {
        "jsonrpc": "2.0",
        "id": vID,
        "result": {
          "tools": [
            {"name": "bt.scan_discovery"},
            {"name": "bt.info"},
            {"name": "bt.services"},
            {"name": "bt.l2ping"},
            {"name": "bt.scan_le"},
            {"name": "report.write"},
            {"name": "report.final_md"},
            {"name": "report.final_html"}
          ]
        }
      }
      await vWS.send(json.dumps(vRespuesta))
      continue

    if vMethod == "tools/call":
      vTool = vJSON["params"]["tool"]
      vArgs = vJSON["params"]["arguments"]

      print(f"[MCP] Ejecutando herramienta: {vTool}")

      vOutput = {}

      if vTool == "bt.scan_discovery":
        vOutput = fBtScanDiscovery(
          vArgs.get("workspace"), 
          vArgs.get("timeout")
        )

      elif vTool == "bt.info":
        vOutput = fBtInfo(
          vArgs.get("mac"), 
          vArgs.get("workspace")
        )

      elif vTool == "bt.services":
        vOutput = fBtServices(
          vArgs.get("mac"), 
          vArgs.get("workspace")
        )

      elif vTool == "bt.l2ping":
        vOutput = fBtL2Ping(
          vArgs.get("mac"), 
          vArgs.get("count"), 
          vArgs.get("workspace")
        )

      elif vTool == "bt.scan_le":
        vOutput = fBtScanLE(
          vArgs.get("workspace"), 
          vArgs.get("timeout")
        )

      elif vTool == "report.write":
        vOutput = fReportWrite(vArgs["workspace"], vArgs["section"], vArgs["content"])
      
      elif vTool == "report.final_md":
        vOutput = fReportFinalMD(vArgs["workspace"], vArgs["content"])
      
      elif vTool == "report.final_html":
        vOutput = fReportFinalHTML(vArgs["workspace"], vArgs["content"])

      # Enviar respuesta
      vRespuesta = {
        "jsonrpc": "2.0",
        "id": vID,
        "result": {"output": vOutput}
      }
      await vWS.send(json.dumps(vRespuesta))
      continue


# --------------------------------------------------------
# MAIN SERVER
# --------------------------------------------------------

async def main():
  print(f"\n{'='*60}")
  print(f"MCP BLUETOOTH Pentesting Server")
  print(f"{'='*60}")
  print(f"Escuchando en: ws://{vHost}:{vPort}")
  print(f"Estado: ACTIVO")
  print(f"{'='*60}\n")
  print("Esperando conexiones...\n")

  async with websockets.serve(fHandle, vHost, vPort):
    await asyncio.Future()

if __name__ == "__main__":
  asyncio.run(main())
