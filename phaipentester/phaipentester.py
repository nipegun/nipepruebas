#!/usr/bin/env python3

"""
PHIAPentester - Menú Principal
Framework de Pentesting Automatizado con IA

Permite elegir entre diferentes tipos de pentesting:
- Web Application Pentesting
- Network Pentesting
- Wireless Pentesting (WiFi, Bluetooth, etc.)
"""

import os
import sys
import subprocess
import argparse

# --------------------------------------------------------
# CONFIGURACIÓN
# --------------------------------------------------------

vRutaBase = os.path.dirname(os.path.abspath(__file__))

vRutaWeb = os.path.join(vRutaBase, "web", "orchestrator.py")
vRutaNetwork = os.path.join(vRutaBase, "network", "orchestrator.py")
vRutaWireless = os.path.join(vRutaBase, "wireless", "orchestrator.py")

# URL por defecto de la API de IA
vURLAIAPI = "http://127.0.0.1:9000/completion"

# --------------------------------------------------------
# FUNCIONES
# --------------------------------------------------------

def fMostrarBanner(vURLAPI):
  print("\n" + "="*70)
  print("""
  ██████╗ ██╗  ██╗     ██╗ █████╗  ██████╗ ███████╗███╗   ██╗████████╗███████╗███████╗████████╗███████╗██████╗
  ██╔══██╗██║  ██║     ██║██╔══██╗ ██╔══██╗██╔════╝████╗  ██║╚══██╔══╝██╔════╝██╔════╝╚══██╔══╝██╔════╝██╔══██╗
  ██████╔╝███████║ ██╗ ██║███████║ ██████╔╝█████╗  ██╔██╗ ██║   ██║   █████╗  ███████╗   ██║   █████╗  ██████╔╝
  ██╔═══╝ ██╔══██║ ╚═╝ ██║██╔══██║ ██╔═══╝ ██╔══╝  ██║╚██╗██║   ██║   ██╔══╝  ╚════██║   ██║   ██╔══╝  ██╔══██╗
  ██║     ██║  ██║     ██║██║  ██║ ██║     ███████╗██║ ╚████║   ██║   ███████╗███████║   ██║   ███████╗██║  ██║
  ╚═╝     ╚═╝  ╚═╝     ╚═╝╚═╝  ╚═╝ ╚═╝     ╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚══════╝╚══════╝   ╚═╝   ╚══════╝╚═╝  ╚═╝
  """)
  print("  Framework de Pentesting Automatizado con Inteligencia Artificial")
  print(f"  AI API: {vURLAPI}")
  print("="*70 + "\n")

def fMostrarMenu():
  print("Selecciona el tipo de pentesting que deseas realizar:\n")
  print("  [1] Web Application Pentesting")
  print("      └─ Análisis de aplicaciones web, APIs, vulnerabilidades OWASP")
  print()
  print("  [2] Network Pentesting")
  print("      └─ Escaneo de redes, análisis de puertos, vulnerabilidades de red")
  print()
  print("  [3] Wireless Pentesting")
  print("      └─ WiFi, Bluetooth, redes inalámbricas")
  print()
  print("  [0] Salir")
  print()

def fVerificarFramework(vRuta, vNombre):
  if not os.path.exists(vRuta):
    print(f"\n✗ ERROR: El framework de {vNombre} aún no está disponible.")
    print(f"  Archivo esperado: {vRuta}")
    print(f"  Por favor, completa la configuración de {vNombre} primero.\n")
    return False
  return True

def fEjecutarFramework(vRuta, vNombre, vURLAPI):
  if not fVerificarFramework(vRuta, vNombre):
    return

  print(f"\n{'='*70}")
  print(f"Iniciando {vNombre}...")
  print(f"Usando AI API: {vURLAPI}")
  print(f"{'='*70}\n")

  try:
    # Pasar la URL de la API como variable de entorno
    vEnv = os.environ.copy()
    vEnv["PHIA_AI_API_URL"] = vURLAPI

    # Ejecutar el orchestrator correspondiente
    subprocess.run([sys.executable, vRuta], env=vEnv)
  except KeyboardInterrupt:
    print(f"\n\n{'='*70}")
    print(f"{vNombre} interrumpido por el usuario.")
    print(f"{'='*70}\n")
  except Exception as e:
    print(f"\n✗ ERROR al ejecutar {vNombre}: {e}\n")

def fMain(vURLAPI):
  while True:
    fMostrarBanner(vURLAPI)
    fMostrarMenu()

    vOpcion = input("Selecciona una opción [0-3]: ").strip()

    if vOpcion == "1":
      fEjecutarFramework(vRutaWeb, "Web Application Pentesting", vURLAPI)

    elif vOpcion == "2":
      fEjecutarFramework(vRutaNetwork, "Network Pentesting", vURLAPI)

    elif vOpcion == "3":
      fEjecutarFramework(vRutaWireless, "Wireless Pentesting", vURLAPI)

    elif vOpcion == "0":
      print("\n" + "="*70)
      print("Saliendo de PHIAPentester...")
      print("="*70 + "\n")
      sys.exit(0)

    else:
      print("\n✗ Opción inválida. Por favor selecciona una opción válida [0-3].\n")
      input("Presiona ENTER para continuar...")

    # Pausar antes de volver al menú
    if vOpcion in ["1", "2", "3"]:
      input("\nPresiona ENTER para volver al menú principal...")

# --------------------------------------------------------
# MAIN
# --------------------------------------------------------

if __name__ == "__main__":
  # Parsear argumentos de línea de comandos
  parser = argparse.ArgumentParser(
    description="PHIAPentester - Framework de Pentesting Automatizado con IA",
    formatter_class=argparse.RawDescriptionHelpFormatter,
    epilog="""
Ejemplos de uso:
  # Modo interactivo (menú)
  python3 phiapentester.py
  python3 phiapentester.py -aiapi http://127.0.0.1:9000/completion

  # Modo directo (sin menú)
  python3 phiapentester.py --framework web --target http://ejemplo.com
  python3 phiapentester.py --framework web --target http://ejemplo.com -aiapi http://127.0.0.1:9000/completion
  python3 phiapentester.py --framework network --target 192.168.1.0/24
    """
  )

  parser.add_argument(
    "-aiapi",
    "--ai-api-url",
    dest="aiapi",
    default=vURLAIAPI,
    help=f"URL de la API de IA (por defecto: {vURLAIAPI})"
  )

  parser.add_argument(
    "--framework",
    "-f",
    dest="framework",
    choices=["web", "network", "wireless"],
    help="Framework a usar (omitir para menú interactivo)"
  )

  parser.add_argument(
    "--target",
    "-t",
    dest="target",
    help="Objetivo del pentesting (URL, IP, rango de red, etc.)"
  )

  args = parser.parse_args()

  # Validar que si se usa --framework, también se use --target
  if args.framework and not args.target:
    parser.error("--framework requiere --target")
  if args.target and not args.framework:
    parser.error("--target requiere --framework")

  try:
    # Modo directo: ejecutar framework específico sin menú
    if args.framework:
      vRutaFramework = None
      vNombre = None

      if args.framework == "web":
        vRutaFramework = vRutaWeb
        vNombre = "Web Application Pentesting"
      elif args.framework == "network":
        vRutaFramework = vRutaNetwork
        vNombre = "Network Pentesting"
      elif args.framework == "wireless":
        vRutaFramework = vRutaWireless
        vNombre = "Wireless Pentesting"

      if not os.path.exists(vRutaFramework):
        print(f"\n✗ ERROR: El framework '{args.framework}' no está disponible.")
        print(f"  Archivo esperado: {vRutaFramework}\n")
        sys.exit(1)

      print(f"\n{'='*70}")
      print(f"PHIAPentester - Modo Directo")
      print(f"{'='*70}")
      print(f"Framework: {vNombre}")
      print(f"Target:    {args.target}")
      print(f"AI API:    {args.aiapi}")
      print(f"{'='*70}\n")

      # Configurar variables de entorno
      vEnv = os.environ.copy()
      vEnv["PHIA_AI_API_URL"] = args.aiapi
      vEnv["PHIA_TARGET"] = args.target

      # Ejecutar framework
      subprocess.run([sys.executable, vRutaFramework], env=vEnv)

    else:
      # Modo interactivo: mostrar menú
      fMain(args.aiapi)

  except KeyboardInterrupt:
    print("\n\n" + "="*70)
    print("PHIAPentester interrumpido por el usuario.")
    print("="*70 + "\n")
    sys.exit(0)
