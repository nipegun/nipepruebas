#!/usr/bin/env python3

"""
phaipentester - Menú Principal
Framework de Pentesting Automatizado con IA

Permite elegir entre diferentes tipos de pentesting:
- Web Application Pentesting
- Lanwired Pentesting
- Wireless Pentesting (WiFi)
- Bluetooth Pentesting
- Active Directory Pentesting
"""

import os
import sys
import subprocess
import argparse
import json

# --------------------------------------------------------
# CONFIGURACIÓN
# --------------------------------------------------------

vRutaBase = os.path.dirname(os.path.abspath(__file__))

vRutaWeb = os.path.join(vRutaBase, "web", "orchestrator.py")
vRutaLanwired = os.path.join(vRutaBase, "lan", "orchestrator.py")
vRutaWireless = os.path.join(vRutaBase, "wifi", "orchestrator.py")
vRutaBluetooth = os.path.join(vRutaBase, "bt", "orchestrator.py")
vRutaAD = os.path.join(vRutaBase, "ad", "orchestrator.py")

# Archivos de configuración
vRutaAPITxt = os.path.join(vRutaBase, "api.txt")
vRutaAPIURLs = os.path.join(vRutaBase, "apiurls.json")
vRutaAPIKeys = os.path.join(vRutaBase, "apikeys.json")

# Configuración de proveedores de IA
vProveedoresIA = {
  "llama.cpp": {
    "nombre": "llama.cpp (Local)",
    "url": "http://127.0.0.1:9000/completion",
    "requiere_api_key": False
  },
  "ollama": {
    "nombre": "Ollama (Local)",
    "url": "http://localhost:11434/v1/chat/completions",
    "requiere_api_key": False
  },
  "vllm": {
    "nombre": "vLLM (Local)",
    "url": "http://localhost:8000/v1/chat/completions",
    "requiere_api_key": False
  },
  "deepseek": {
    "nombre": "DeepSeek API",
    "url": "https://api.deepseek.com/v1/chat/completions",
    "requiere_api_key": True
  },
  "openai": {
    "nombre": "OpenAI API",
    "url": "https://api.openai.com/v1/chat/completions",
    "requiere_api_key": True
  },
  "claude": {
    "nombre": "Claude API (Anthropic)",
    "url": "https://api.anthropic.com/v1/messages",
    "requiere_api_key": True
  }
}

# Proveedor por defecto
vProveedorDefecto = "llama.cpp"
vURLAIAPI = vProveedoresIA[vProveedorDefecto]["url"]

# --------------------------------------------------------
# FUNCIONES
# --------------------------------------------------------

def fLeerURLsDesdeConfig():
  """Lee las URLs de las APIs desde apiurls.json"""
  vURLsDefecto = {
    "llama": "http://127.0.0.1:9000/completion",
    "deepseek": "https://api.deepseek.com/v1/chat/completions"
  }

  if not os.path.exists(vRutaAPIURLs):
    return vURLsDefecto

  try:
    with open(vRutaAPIURLs, "r") as f:
      vURLs = json.load(f)
      return vURLs
  except Exception as e:
    print(f"⚠ Error al leer apiurls.json: {e}, usando URLs por defecto")
    return vURLsDefecto

def fLeerAPIKeysDesdeConfig():
  """Lee las API keys desde apikeys.json"""
  if not os.path.exists(vRutaAPIKeys):
    return {}

  try:
    with open(vRutaAPIKeys, "r") as f:
      vKeys = json.load(f)
      return vKeys
  except Exception as e:
    print(f"⚠ Error al leer apikeys.json: {e}")
    return {}

def fGuardarAPIKey(vProveedor, vAPIKey):
  """Guarda una API key en apikeys.json"""
  vKeys = fLeerAPIKeysDesdeConfig()
  vKeys[vProveedor] = vAPIKey

  try:
    with open(vRutaAPIKeys, "w") as f:
      json.dump(vKeys, f, indent=2)
    return True
  except Exception as e:
    print(f"⚠ Error al guardar API key: {e}")
    return False

def fGuardarProveedorEnConfig(vProveedor):
  """Guarda el proveedor seleccionado en api.txt"""
  try:
    # Normalizar el nombre del proveedor
    vNombreNormalizado = vProveedor
    if vProveedor == "llama.cpp":
      vNombreNormalizado = "llama"
    elif vProveedor == "deepseek":
      vNombreNormalizado = "deepseek"

    with open(vRutaAPITxt, "w") as f:
      f.write(vNombreNormalizado + "\n")
    return True
  except Exception as e:
    print(f"⚠ Error al guardar en api.txt: {e}")
    return False

def fSeleccionarProveedorDesdeAPIURLs():
  """
  Muestra menú de selección de proveedores disponibles en apiurls.json
  y guarda la selección en api.txt
  """
  # Leer proveedores disponibles desde apiurls.json
  vURLsConfig = fLeerURLsDesdeConfig()

  if not vURLsConfig:
    print("\n⚠ No se encontraron proveedores en apiurls.json")
    print("Usando llama.cpp por defecto\n")
    fGuardarProveedorEnConfig("llama")
    return "llama.cpp"

  print("\n" + "="*70)
  print("CONFIGURACIÓN INICIAL - SELECCIÓN DE PROVEEDOR DE IA")
  print("="*70)
  print("\nNo se encontró el archivo api.txt.")
  print("Por favor selecciona el proveedor de IA que deseas usar por defecto:\n")

  # Crear mapeo de opciones
  aProveedores = list(vURLsConfig.keys())
  dMapeo = {}

  for i, vProveedor in enumerate(aProveedores, 1):
    dMapeo[str(i)] = vProveedor

    # Mapear nombre de apiurls.json a nombre interno para obtener el display correcto
    if vProveedor == "llama":
      vProveedorInterno = "llama.cpp"
    else:
      vProveedorInterno = vProveedor

    # Obtener nombre de display del diccionario vProveedoresIA
    if vProveedorInterno in vProveedoresIA:
      vNombreDisplay = vProveedoresIA[vProveedorInterno]["nombre"]
    else:
      vNombreDisplay = f"{vProveedor.capitalize()} API"

    print(f"  [{i}] {vNombreDisplay}")
    print(f"      └─ URL: {vURLsConfig[vProveedor]}")
    print()

  print("="*70)

  while True:
    vOpcion = input(f"\nSelecciona proveedor [1-{len(aProveedores)}]: ").strip()

    if vOpcion in dMapeo:
      vProveedorSeleccionado = dMapeo[vOpcion]

      # Confirmar selección - obtener nombre de display correcto
      if vProveedorSeleccionado == "llama":
        vProveedorInterno = "llama.cpp"
      else:
        vProveedorInterno = vProveedorSeleccionado

      if vProveedorInterno in vProveedoresIA:
        vNombreDisplay = vProveedoresIA[vProveedorInterno]["nombre"]
      else:
        vNombreDisplay = vProveedorSeleccionado

      print(f"\n✓ Has seleccionado: {vNombreDisplay}")

      # Guardar en api.txt
      if fGuardarProveedorEnConfig(vProveedorSeleccionado):
        print(f"✓ Configuración guardada en api.txt")
      else:
        print("⚠ No se pudo guardar la configuración, pero se usará esta sesión")

      # Si es DeepSeek, OpenAI o Claude, solicitar API key inmediatamente
      if vProveedorSeleccionado in ["deepseek", "openai", "claude"]:
        if vProveedorSeleccionado == "deepseek":
          vNombreProveedor = "DeepSeek"
          vURLAPIKey = "https://platform.deepseek.com/api_keys"
        elif vProveedorSeleccionado == "openai":
          vNombreProveedor = "OpenAI"
          vURLAPIKey = "https://platform.openai.com/api-keys"
        else:  # claude
          vNombreProveedor = "Claude"
          vURLAPIKey = "https://console.anthropic.com/settings/keys"

        print("\n" + "="*70)
        print(f"CONFIGURACIÓN DE API KEY PARA {vNombreProveedor.upper()}")
        print("="*70)
        print(f"{vNombreProveedor} requiere una API key para funcionar.")
        print(f"Puedes obtenerla en: {vURLAPIKey}\n")

        while True:
          vAPIKey = input(f"Ingresa tu API key de {vNombreProveedor}: ").strip()

          if vAPIKey:
            # Guardar la API key
            if fGuardarAPIKey(vProveedorSeleccionado, vAPIKey):
              print("✓ API key guardada correctamente en apikeys.json")
            else:
              print("⚠ No se pudo guardar la API key, pero se usará esta sesión")
            break
          else:
            print("✗ La API key no puede estar vacía. Por favor ingrésala.")

        print("="*70 + "\n")

      print("Puedes cambiar el proveedor en cualquier momento editando api.txt")
      print("o usando el argumento --provider en línea de comandos.\n")

      # Convertir a formato interno
      if vProveedorSeleccionado == "llama":
        return "llama.cpp"
      else:
        return vProveedorSeleccionado

    else:
      print(f"✗ Opción inválida. Por favor selecciona un número entre 1 y {len(aProveedores)}.")

def fLeerProveedorDesdeConfig():
  """Lee el proveedor de IA desde api.txt. Si no existe, permite seleccionar uno."""
  if not os.path.exists(vRutaAPITxt):
    # Primera ejecución: permitir seleccionar proveedor
    return fSeleccionarProveedorDesdeAPIURLs()

  try:
    with open(vRutaAPITxt, "r") as f:
      vProveedor = f.read().strip().lower()

      # Leer proveedores disponibles desde apiurls.json
      vURLsConfig = fLeerURLsDesdeConfig()

      # Validar que el proveedor existe en apiurls.json
      if vProveedor not in vURLsConfig:
        print("\n" + "="*70)
        print("ERROR: PROVEEDOR DE IA NO ENCONTRADO")
        print("="*70)
        print(f"El archivo api.txt contiene el proveedor '{vProveedor}'")
        print(f"pero este proveedor NO existe en apiurls.json\n")
        print(f"Proveedores disponibles en apiurls.json:")
        for vProv in vURLsConfig.keys():
          print(f"  - {vProv}")
        print("\nPor favor:")
        print(f"  1. Edita api.txt y pon un proveedor válido, o")
        print(f"  2. Agrega '{vProveedor}' a apiurls.json con su URL")
        print("="*70 + "\n")
        sys.exit(1)

      # Normalizar nombres para uso interno
      if vProveedor == "llama":
        return "llama.cpp"
      elif vProveedor == "ollama":
        return "ollama"
      elif vProveedor == "vllm":
        return "vllm"
      elif vProveedor in ["deepseek", "deep-seek"]:
        return "deepseek"
      elif vProveedor in ["openai", "gpt"]:
        return "openai"
      elif vProveedor in ["claude", "anthropic"]:
        return "claude"
      else:
        # Usar el nombre tal cual si existe en apiurls.json
        return vProveedor

  except Exception as e:
    print(f"⚠ Error al leer api.txt: {e}")
    print("Iniciando configuración inicial...")
    return fSeleccionarProveedorDesdeAPIURLs()

def fMostrarBanner(vURLAPI):
  print("\n" + "="*70)
  print("""
  ██████╗ ██╗  ██╗  █████╗  ██╗ ██████╗ ███████╗███╗   ██╗████████╗███████╗███████╗████████╗███████╗██████╗
  ██╔══██╗██║  ██║ ██╔══██╗ ██║ ██╔══██╗██╔════╝████╗  ██║╚══██╔══╝██╔════╝██╔════╝╚══██╔══╝██╔════╝██╔══██╗
  ██████╔╝███████║ ███████║ ██║ ██████╔╝█████╗  ██╔██╗ ██║   ██║   █████╗  ███████╗   ██║   █████╗  ██████╔╝
  ██╔═══╝ ██╔══██║ ██╔══██║ ██║ ██╔═══╝ ██╔══╝  ██║╚██╗██║   ██║   ██╔══╝  ╚════██║   ██║   ██╔══╝  ██╔══██╗
  ██║     ██║  ██║ ██║  ██║ ██║ ██║     ███████╗██║ ╚████║   ██║   ███████╗███████║   ██║   ███████╗██║  ██║
  ╚═╝     ╚═╝  ╚═╝ ╚═╝  ╚═╝ ╚═╝ ╚═╝     ╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚══════╝╚══════╝   ╚═╝   ╚══════╝╚═╝  ╚═╝
  """)
  print("          Framework de Pentesting Automatizado con Inteligencia Artificial de la empresa PYMEHackers")
  print("")
  print(f"  AI API: {vURLAPI}")
  print("="*70 + "\n")

def fSeleccionarProveedorIA():
  """Muestra menú de proveedores de IA y retorna la configuración seleccionada"""
  # Leer configuración desde archivos
  vURLsConfig = fLeerURLsDesdeConfig()
  vKeysConfig = fLeerAPIKeysDesdeConfig()

  print("\n" + "="*70)
  print("SELECCIÓN DE PROVEEDOR DE IA")
  print("="*70)
  print("Selecciona el proveedor de inteligencia artificial a utilizar:\n")
  print("  [1] llama.cpp (Local)")
  print("      └─ Modelo local ejecutándose en tu máquina")
  print(f"      └─ URL: {vURLsConfig.get('llama', 'http://127.0.0.1:9000/completion')}")
  print()
  print("  [2] DeepSeek API")
  print("      └─ Modelo en la nube de DeepSeek")
  print(f"      └─ URL: {vURLsConfig.get('deepseek', 'https://api.deepseek.com/v1/chat/completions')}")
  vAPIKeyGuardada = vKeysConfig.get("deepseek", "")
  if vAPIKeyGuardada:
    print(f"      └─ API key guardada: {'*' * (len(vAPIKeyGuardada) - 4) + vAPIKeyGuardada[-4:]}")
  else:
    print("      └─ Requiere API key (https://platform.deepseek.com/api_keys)")
  print()
  print("="*70)

  while True:
    vOpcion = input("\nSelecciona proveedor [1-2] (por defecto: 1): ").strip()

    if vOpcion == "" or vOpcion == "1":
      vProveedor = "llama.cpp"
      vURL = vURLsConfig.get("llama", "http://127.0.0.1:9000/completion")
      vAPIKey = None

      # Permitir personalizar la URL
      vURLCustom = input(f"\nURL de llama.cpp (Enter para usar {vURL}): ").strip()
      if vURLCustom:
        vURL = vURLCustom

      return vProveedor, vURL, vAPIKey

    elif vOpcion == "2":
      vProveedor = "deepseek"
      vURL = vURLsConfig.get("deepseek", "https://api.deepseek.com/v1/chat/completions")

      # Verificar si hay API key guardada
      vAPIKey = vAPIKeyGuardada

      if vAPIKey:
        vUsar = input(f"\n¿Usar API key guardada ({'*' * (len(vAPIKey) - 4) + vAPIKey[-4:]})? (S/n): ").strip().lower()
        if vUsar in ['n', 'no']:
          vAPIKey = None

      if not vAPIKey:
        # Solicitar API key
        print("\nPara usar DeepSeek necesitas una API key.")
        print("Puedes obtenerla en: https://platform.deepseek.com/api_keys")

        vAPIKey = input("\nIngresa tu API key de DeepSeek: ").strip()

        if not vAPIKey:
          print("✗ API key requerida para usar DeepSeek.")
          continue

        # Preguntar si quiere guardar la API key
        vGuardar = input("\n¿Guardar esta API key en apikeys.json? (S/n): ").strip().lower()
        if vGuardar != 'n' and vGuardar != 'no':
          if fGuardarAPIKey("deepseek", vAPIKey):
            print("✓ API key guardada correctamente")
          else:
            print("✗ No se pudo guardar la API key")

      return vProveedor, vURL, vAPIKey

    else:
      print("✗ Opción inválida. Por favor selecciona 1 o 2.")

def fMostrarMenu():
  print("Selecciona el tipo de pentesting que deseas realizar:\n")
  print("  [1] Web Application Pentesting")
  print("      └─ Análisis de aplicaciones web, APIs, vulnerabilidades OWASP")
  print()
  print("  [2] Lanwired Pentesting")
  print("      └─ Escaneo de redes, análisis de puertos, vulnerabilidades de red")
  print()
  print("  [3] Wireless Pentesting")
  print("      └─ WiFi (Aircrack-ng, etc.)")
  print()
  print("  [4] Bluetooth Pentesting")
  print("      └─ Bluetooth Scan, SDP, Info, BLE")
  print()
  print("  [5] Active Directory Pentesting")
  print("      └─ Domain Enum, Kerberoasting, Bloodhound")
  print()
  print("  [0] Salir")
  print()

def fVerificarFramework(vRuta, vNombre):
  if not os.path.exists(vRuta):
    print(f"\n✗ ERROR: El framework de {vNombre} aún no está disponible.")
    print(f"  Archivo esperado: {vRuta}")
    print(f"  Por favor, completa la configuración de {vNombre} primero.\n")
    return False
  return True

def fEjecutarFramework(vRuta, vNombre, vProveedor, vURLAPI, vAPIKey):
  if not fVerificarFramework(vRuta, vNombre):
    return

  # Obtener nombre display del proveedor
  if vProveedor in vProveedoresIA:
    vNombreProveedor = vProveedoresIA[vProveedor]['nombre']
  else:
    vNombreProveedor = f"{vProveedor.capitalize()} API"

  print(f"\n{'='*70}")
  print(f"Iniciando {vNombre}...")
  print(f"Proveedor IA: {vNombreProveedor}")
  print(f"URL API: {vURLAPI}")
  print(f"{'='*70}\n")

  try:
    # Pasar configuración como variables de entorno
    vEnv = os.environ.copy()
    vEnv["PHIA_AI_API_URL"] = vURLAPI
    vEnv["PHIA_AI_PROVIDER"] = vProveedor
    if vAPIKey:
      vEnv["PHIA_AI_API_KEY"] = vAPIKey

    # Ejecutar el orchestrator correspondiente
    subprocess.run([sys.executable, vRuta], env=vEnv)
  except KeyboardInterrupt:
    print(f"\n\n{'='*70}")
    print(f"{vNombre} interrumpido por el usuario.")
    print(f"{'='*70}\n")
  except Exception as e:
    print(f"\n✗ ERROR al ejecutar {vNombre}: {e}\n")

def fMain(vProveedorInit=None, vURLInit=None, vAPIKeyInit=None):
  # Configurar proveedor de IA desde archivos o argumentos
  if vProveedorInit is None:
    # Leer configuración desde archivos
    vProveedor = fLeerProveedorDesdeConfig()
    vURLsConfig = fLeerURLsDesdeConfig()
    vKeysConfig = fLeerAPIKeysDesdeConfig()

    # Obtener URL desde apiurls.json
    vNombreProveedor = "llama" if vProveedor == "llama.cpp" else vProveedor
    vURL = vURLsConfig.get(vNombreProveedor, vProveedoresIA.get(vProveedor, {}).get("url", ""))

    # Obtener API key desde apikeys.json si existe
    vAPIKey = vKeysConfig.get(vProveedor, None)

    # Si es DeepSeek, OpenAI o Claude y no hay API key, solicitarla
    if vProveedor in ["deepseek", "openai", "claude"] and not vAPIKey:
      if vProveedor == "deepseek":
        vNombreProveedor = "DeepSeek"
        vURLAPIKey = "https://platform.deepseek.com/api_keys"
      elif vProveedor == "openai":
        vNombreProveedor = "OpenAI"
        vURLAPIKey = "https://platform.openai.com/api-keys"
      else:  # claude
        vNombreProveedor = "Claude"
        vURLAPIKey = "https://console.anthropic.com/settings/keys"

      print("\n" + "="*70)
      print("CONFIGURACIÓN DE API KEY")
      print("="*70)
      print(f"El proveedor {vNombreProveedor} requiere una API key.")
      print(f"Puedes obtenerla en: {vURLAPIKey}\n")

      while True:
        vAPIKey = input(f"Ingresa tu API key de {vNombreProveedor}: ").strip()

        if vAPIKey:
          # Preguntar si quiere guardar la API key
          vGuardar = input("\n¿Guardar esta API key en apikeys.json? (S/n): ").strip().lower()
          if vGuardar != 'n' and vGuardar != 'no':
            if fGuardarAPIKey(vProveedor, vAPIKey):
              print("✓ API key guardada correctamente\n")
            else:
              print("⚠ No se pudo guardar la API key, pero se usará esta sesión\n")
          break
        else:
          print("✗ La API key no puede estar vacía. Por favor ingrésala.")

      print("="*70 + "\n")
  else:
    vProveedor, vURL, vAPIKey = vProveedorInit, vURLInit, vAPIKeyInit

  while True:
    fMostrarBanner(vURL)
    fMostrarMenu()

    vOpcion = input("Selecciona una opción [0-3]: ").strip()

    if vOpcion == "1":
      fEjecutarFramework(vRutaWeb, "Web Application Pentesting", vProveedor, vURL, vAPIKey)

    elif vOpcion == "2":
      fEjecutarFramework(vRutaLanwired, "Lanwired Pentesting", vProveedor, vURL, vAPIKey)

    elif vOpcion == "3":
      fEjecutarFramework(vRutaWireless, "Wireless Pentesting", vProveedor, vURL, vAPIKey)

    elif vOpcion == "4":
      fEjecutarFramework(vRutaBluetooth, "Bluetooth Pentesting", vProveedor, vURL, vAPIKey)

    elif vOpcion == "5":
      fEjecutarFramework(vRutaAD, "Active Directory Pentesting", vProveedor, vURL, vAPIKey)

    elif vOpcion == "0":
      print("\n" + "="*70)
      print("Saliendo de phaipentester...")
      print("="*70 + "\n")
      sys.exit(0)

    else:
      print("\n✗ Opción inválida. Por favor selecciona una opción válida [0-5].\n")
      input("Presiona ENTER para continuar...")

    # Pausar antes de volver al menú
    if vOpcion in ["1", "2", "3", "4", "5"]:
      input("\nPresiona ENTER para volver al menú principal...")

# --------------------------------------------------------
# MAIN
# --------------------------------------------------------

if __name__ == "__main__":
  # Parsear argumentos de línea de comandos
  parser = argparse.ArgumentParser(
    description="phaipentester - Framework de Pentesting Automatizado con IA",
    formatter_class=argparse.RawDescriptionHelpFormatter,
    epilog="""
Ejemplos de uso:
  # Modo interactivo (menú)
  python3 phaipentester.py
  python3 phaipentester.py -aiapi http://127.0.0.1:9000/completion

  # Modo directo (sin menú)
  python3 phaipentester.py --framework web --target http://ejemplo.com
  python3 phaipentester.py --framework web --target http://ejemplo.com -aiapi http://127.0.0.1:9000/completion
  python3 phaipentester.py --framework lanwired --target 192.168.1.0/24
    """
  )

  parser.add_argument(
    "-aiapi",
    "--ai-api-url",
    dest="aiapi",
    help=f"URL de la API de IA (por defecto depende del proveedor)"
  )

  # Leer proveedor por defecto desde api.txt
  vProveedorPorDefecto = fLeerProveedorDesdeConfig()

  parser.add_argument(
    "--provider",
    "-p",
    dest="provider",
    choices=["llama.cpp", "ollama", "vllm", "deepseek", "openai", "claude"],
    default=vProveedorPorDefecto,
    help=f"Proveedor de IA a usar (por defecto: {vProveedorPorDefecto} según api.txt)"
  )

  parser.add_argument(
    "--api-key",
    "-k",
    dest="apikey",
    help="API key para el proveedor (requerida para DeepSeek)"
  )

  parser.add_argument(
    "--framework",
    "-f",
    dest="framework",
    choices=["web", "lanwired", "wireless", "bluetooth", "ad"],
    help="Framework a usar (omitir para menú interactivo)"
  )

  parser.add_argument(
    "--target",
    "-t",
    dest="target",
    help="Objetivo del pentesting (URL, IP, rango de red, etc.)"
  )

  args = parser.parse_args()

  # Validar que si se usa --framework, también se use --target
  if args.framework and not args.target:
    parser.error("--framework requiere --target")
  if args.target and not args.framework:
    parser.error("--target requiere --framework")

  # Leer configuración desde archivos
  vURLsConfig = fLeerURLsDesdeConfig()
  vKeysConfig = fLeerAPIKeysDesdeConfig()

  # Configurar proveedor y URL
  vProveedor = args.provider

  # Obtener URL desde argumentos, o desde apiurls.json, o usar valor por defecto
  if args.aiapi:
    vURL = args.aiapi
  else:
    # Mapear nombre del proveedor al nombre usado en apiurls.json
    vNombreProveedor = "llama" if vProveedor == "llama.cpp" else vProveedor
    vURL = vURLsConfig.get(vNombreProveedor, vProveedoresIA[vProveedor]["url"])

  # Obtener API key desde argumentos o desde apikeys.json
  vAPIKey = args.apikey if args.apikey else vKeysConfig.get(vProveedor, None)

  # Validar que los proveedores cloud requieren API key
  if vProveedor in ["deepseek", "openai", "claude"] and not vAPIKey:
    parser.error(f"--provider {vProveedor} requiere --api-key o una API key guardada en apikeys.json")

  try:
    # Modo directo: ejecutar framework específico sin menú
    if args.framework:
      vRutaFramework = None
      vNombre = None

      if args.framework == "web":
        vRutaFramework = vRutaWeb
        vNombre = "Web Application Pentesting"
      elif args.framework == "lanwired":
        vRutaFramework = vRutaLanwired
        vNombre = "Lanwired Pentesting"
      elif args.framework == "wireless":
        vRutaFramework = vRutaWireless
        vNombre = "Wireless Pentesting"
      elif args.framework == "bluetooth":
        vRutaFramework = vRutaBluetooth
        vNombre = "Bluetooth Pentesting"
      elif args.framework == "ad":
        vRutaFramework = vRutaAD
        vNombre = "Active Directory Pentesting"

      if not os.path.exists(vRutaFramework):
        print(f"\n✗ ERROR: El framework '{args.framework}' no está disponible.")
        print(f"  Archivo esperado: {vRutaFramework}\n")
        sys.exit(1)

      print(f"\n{'='*70}")
      print(f"phaipentester - Modo Directo")
      print(f"{'='*70}")
      print(f"Framework:  {vNombre}")
      print(f"Target:     {args.target}")
      print(f"Proveedor:  {vProveedoresIA[vProveedor]['nombre']}")
      print(f"AI API:     {vURL}")
      print(f"{'='*70}\n")

      # Configurar variables de entorno
      vEnv = os.environ.copy()
      vEnv["PHIA_AI_API_URL"] = vURL
      vEnv["PHIA_AI_PROVIDER"] = vProveedor
      vEnv["PHIA_TARGET"] = args.target
      if vAPIKey:
        vEnv["PHIA_AI_API_KEY"] = vAPIKey

      # Ejecutar framework
      subprocess.run([sys.executable, vRutaFramework], env=vEnv)

    else:
      # Modo interactivo: mostrar menú
      if args.aiapi or args.apikey:
        # Si se proporcionaron argumentos de proveedor en línea de comandos
        fMain(vProveedor, vURL, vAPIKey)
      else:
        # Modo interactivo completo
        fMain()

  except KeyboardInterrupt:
    print("\n\n" + "="*70)
    print("phaipentester interrumpido por el usuario.")
    print("="*70 + "\n")
    sys.exit(0)
